#!/usr/bin/env bash

PROC_DIR="$1"
shift
PROXIES_ADDRESS=("$@")

get_new_proxy() {
	local curr="$PROC_DIR/current"

	[ -f "$curr" ] || echo -n 0 >"$curr"

	local proxy_id="$(cat "$curr")"
	echo -n $(expr \( $proxy_id + 1 \) % ${#PROXIES_ADDRESS[@]}) >"$curr"

	echo "${PROXIES_ADDRESS[$proxy_id]}"
}

get_host() {
	echo "$1" |
		grep -oP '^(([0-9a-z]+\.)*[0-9a-z]+|([0-9]{1,3}\.){3}[0-9]{1,3})?' ||
		echo -n '0.0.0.0'
}

get_port() {
	echo "$1" |
		grep -oP '(?<=:)[0-9]{1,5}$'
}

proxy="$(get_new_proxy)"
initial_proxy="$proxy"

while [ -f "${PROC_DIR}/${proxy}.unhealthy" ]; do
	proxy="$(get_new_proxy)"
	if [ "$proxy" = "$initial_proxy" ]; then
		echo 'all proxies are down.' >&2
		exit 1
	fi
done
host="$(get_host "$proxy")"
port="$(get_port "$proxy")"

socat STDIO TCP:$host:$port
